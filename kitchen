#!/usr/bin/env sh

CONTEXT=$PWD                    # Build from CONTEXT folder
PROJECT=$(basename "$CONTEXT")  # Name image TAGBASE:sometag
REQFILE="requirements.txt"      # Install packages from REQFILE
WORKDIR="/context"              # Copy/mount files to WORKDIR in container

help() {
  echo "Run disposable containers built from $CONTEXT"
  echo
  echo "COMMANDS"
  echo "alamode [TAG] [CMD]     Bake $PROJECT:TAG, freeze it, and serve CMD"
  echo "bake [TAG]              Build $PROJECT:TAG image from $CONTEXT"
  echo "clean                   Delete all $PROJECT containers and Docker leftovers"
  echo "debug TAG SCRIPT [ARGS] Debug SCRIPT in a $PROJECT:TAG container"
  echo "eightysix [TAG]         Delete $PROJECT:TAG image, containers, and leftovers"
  echo "freeze [TAG]            Update $REQFILE and rebuild $PROJECT:TAG image"
  echo "help                    Show commands, examples, and Docker inventory"
  echo "runit [TAG] [CMD]       Run CMD in an interactive $PROJECT:TAG container"
  echo "serve [TAG] [CMD]       runit [TAG] [CMD] with $CONTEXT mounted as $WORKDIR"
  echo
  echo "EXAMPLES"
  echo "./kitchen bake latest"
  echo "./kitchen serve latest"
  echo "./kitchen serve latest python -m this"
  echo
  echo "INVENTORY"
  echo "---- Images ----" && docker image ls | sort
  echo "---- Volumes ----" && docker volume ls | sort
  echo "---- Networks ----" && docker network ls
  echo "---- Containers ----" && docker ps --all
}
alamode() {
  bake "$1" && freeze "$1" && serve "$@"
}
bake() {
  touch "$REQFILE" &&
  docker build \
    --tag "$PROJECT:${1:-latest}" \
    --build-arg WORKDIR="$WORKDIR" \
    "$CONTEXT" &&
  docker image prune --force
}
clean() {
  docker ps --quiet --filter ancestor="$PROJECT" | xargs docker rm --force &&
  docker system prune --force
}
debug() {
  serve "$1" python -m pdb "${@:2}"
}
eightysix() {
  clean && docker rmi --force "$PROJECT:${1:-latest}" && docker image prune --force
}
freeze() {
  docker run --rm "$PROJECT:${1:-latest}" pip freeze --exclude-editable > "$REQFILE" &&
  bake "$1"
}
runit() {
  docker run --rm --interactive --tty "$PROJECT:${1:-latest}" "${@:2}"
}
serve() {
  docker run --rm --interactive --tty \
    --volume "${CONTEXT}:${WORKDIR}:delegated" \
    --hostname "${PROJECT}" \
    "$PROJECT:${1:-latest}" "${@:2}"
}

if [ $# -eq 0 ]; then help; else "$@"; fi
